//CREATE OR REPLACE VIEW DGTL_DB_COLLAB.LAB_PORTFOLIO_SOLUTIONS.FORECAST_ACTUALS AS
-- DROP VIEW DGTL_DB_COLLAB.LAB_PORTFOLIO_SOLUTIONS.FORECAST_ACTUALS;

--==THIS QUERY EXTRACTS ALL THE EPIC'S==--  
WITH EPIC AS(  
 SELECT
   EPIC_ID,
   EPIC_NAME,
   EPIC_DESCRIPTION,
   EPIC_STATE,
   EP.FK_PROGRAM_ID,
   EP.FK_THEME_ID
FROM DEXP_DB.PHDP_DEXP.JA_EPIC_BC AS EP
)

--==THIS QUERY CREATES THE EPIC FORECAST TABLE==-
,EPIC_FCST AS
(  
SELECT
   FK_EPIC_ID,
   ESTIMATE_FLOAT_VALUE AS ESTIMATE_POINT,
   FK_PROGRAM_INCREMENT_ID,
   ESTIMATION_OBJECT,
   DELETED_FLAG
FROM DEXP_DB.PHDP_DEXP.JA_EPIC_FORECAST_BC
)  
 
--==THIS QUERY EXTRACTS PROGRAM INCREMENT TABLE==--  
,PROGRAM_INCREMENT AS(
 SELECT
   PROGRAM_INCREMENT_ID,
   PI_SHORT_NAME,
   PI_NAME,
   PI_NUMBER,
   DATE_PI_START,
   DATE_PI_END
 FROM DEXP_DB.PHDP_DEXP.JA_PROGRAM_INCREMENT_BC
)

--==THIS QUERY EXTRACTS FEATURE TABLE==--    
,FEATURE AS(
 SELECT
  FEATURE_ID,
  FEATURE_NAME,
  FEATURE_DESCRIPTION,
  FK_PROGRAM_INCREMENT_ID AS FT_FK_PROGRAM_INCREMENT_ID,
  FK_EPIC_ID AS FT_FK_EPIC_ID
 FROM DEXP_DB.PHDP_DEXP.JA_FEATURE_BC
)  
--==THIS QUERY EXTRACTS STORY TABLE==--    
,STORY AS(
 SELECT  
  FK_FEATURE_ID AS STRY_FK_FEATURE_ID,
  SUM(LEVEL_OF_EFFORT) AS STORY_POINT
 FROM DEXP_DB.PHDP_DEXP.JA_STORY_BC
  WHERE 1=1
  GROUP BY 1
 )
  --==THIS QUERY COMBINES ALL THE TABLES==--
 SELECT*
   FROM EPIC AS EP
    INNER JOIN EPIC_FCST AS EPF ON EPF.FK_EPIC_ID = EP.EPIC_ID
    INNER JOIN PROGRAM_INCREMENT AS PI ON EPF.FK_PROGRAM_INCREMENT_ID = PI.PROGRAM_INCREMENT_ID
    LEFT JOIN FEATURE AS FT ON FT.FT_FK_EPIC_ID = EP.EPIC_ID
    AND FT.FT_FK_PROGRAM_INCREMENT_ID = EPF.FK_PROGRAM_INCREMENT_ID
    LEFT JOIN STORY AS STRY ON STRY.STRY_FK_FEATURE_ID = FT.FEATURE_ID
   WHERE 1=1
      AND EP.FK_PROGRAM_ID = 356
      AND EP.EPIC_NAME = 'DFS 2023 Mobile Reporting'
//      AND EPIC_ID = 22460
      AND NOT EP.EPIC_STATE LIKE'%3%'
      AND EPF.ESTIMATION_OBJECT = 'Program Increment'
      AND EPF.DELETED_FLAG = 'No'
      AND PI.DATE_PI_START <= CURRENT_DATE
      AND PI.DATE_PI_END >= CURRENT_DATE
      AND PI.PI_NAME ILIKE '%CSB%'



 
--== TEST QUERY RESULTS==--
//SELECT
//  EPIC_ID,
//  EPIC_NAME,
//  PI_NAME,
//  ESTIMATE_POINT,
//  SUM (STORY_POINT) AS TOTAL_STORY_POINT
//FROM DGTL_DB_COLLAB.LAB_PORTFOLIO_SOLUTIONS.FORECAST_ACTUALS
//    WHERE 1=1
//   GROUP BY 1,2,3,4
